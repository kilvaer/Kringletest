<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Familiedashboard â€“ Kringlebotn</title>
  <style>
    :root { --bg:#0b132b; --fg:#f0f4f8; --muted:#cbd5e1; --accent:#5bc0be; --warn:#ffd166; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans","Apple Color Emoji","Noto Color Emoji",sans-serif}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;grid-template-rows:auto auto 1fr;gap:16px;padding:24px}
    header{grid-column:1/span 2;display:flex;justify-content:space-between;align-items:baseline;border-bottom:1px solid #1f2937;padding-bottom:8px}
    .clock{font-size:64px;font-weight:700;letter-spacing:2px}
    .date{font-size:24px;color:var(--muted)}
    section{background:#111827;border:1px solid #1f2937;border-radius:12px;padding:16px}
    h2{margin:0 0 12px;font-size:20px;color:var(--accent)}
    .departures{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .dep-list{list-style:none;margin:0;padding:0;font-size:18px}
    .dep-list li{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px dashed #243044}
    .realtime{font-weight:600;color:#a7f3d0}
    .weather-now{display:flex;gap:16px;align-items:center}
    .big-temp{font-size:48px;font-weight:700}
    .small{color:var(--muted);font-size:14px}
    .calendar{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .cal-day h3{margin:0 0 8px;font-size:18px;color:var(--muted)}
    .event{padding:6px 8px;border-left:4px solid #334155;margin:6px 0;background:#0f172a;border-radius:6px}
    .sun{display:flex;gap:24px}
    @media (max-width:1024px){.grid{grid-template-columns:1fr;grid-template-rows:auto;}}
  </style>
</head>
<body>
  <div class="grid">
    <header>
      <div class="clock" id="clock">--:--:--</div>
      <div class="date" id="date">â€”</div>
    </header>

    <section id="weather">
      <h2>VÃ¦r â€“ Kringlebotn (yr.no)</h2>
      <div class="weather-now">
        <div class="big-temp" id="temp">--Â°C</div>
        <div>
          <div id="weather-desc">â€”</div>
          <div class="small" id="wind">Vind â€”</div>
          <div class="small" id="precip">NedbÃ¸r â€”</div>
          <div class="small" id="updated">Oppdatert â€”</div>
        </div>
      </div>
    </section>

    <section id="sun">
      <h2>Sol i dag</h2>
      <div class="sun">
        <div>ðŸŒ… Soloppgang: <span id="sunrise">â€”</span></div>
        <div>ðŸŒ‡ Solnedgang: <span id="sunset">â€”</span></div>
      </div>
    </section>

    <section id="departures">
      <h2>Avganger â€“ Kringlebotn</h2>
      <div class="departures">
        <div>
          <div class="small" id="stopA-name">â€”</div>
          <ul class="dep-list" id="stopA-list"></ul>
        </div>
        <div>
          <div class="small" id="stopB-name">â€”</div>
          <ul class="dep-list" id="stopB-list"></ul>
        </div>
      </div>
    </section>

    <section id="calendar">
      <h2>Familiekalender</h2>
      <div class="calendar">
        <div class="cal-day">
          <h3>I dag</h3>
          <div id="events-today">Ingen hendelser</div>
        </div>
        <div class="cal-day">
          <h3>I morgen</h3>
          <div id="events-tomorrow">Ingen hendelser</div>
        </div>
      </div>
    </section>
  </div>

  <!-- ICAL.js (robust ICS parser) -->
  <script type="module">
    import ICAL from "https://unpkg.com/ical.js/dist/ical.min.js"; // ICAL.js  [5](https://github.com/kewisch/ical.js/)

    /********** CONFIG (your Worker URL is set) **********/
    const ENTUR_CLIENT_NAME = "KilvaerFamilyDashboard â€“ contact: hkilvaer@gmail.com"; // identify your app  [1](https://developer.entur.org/)
    const WORKER_URL = "https://raspy-limit-f41d.hkilvaer.workers.dev/"; // your Cloudflare Worker
    const LAT = 60.33;
    const LON = 5.37;
    const TIMEZONE_OFFSET = "+01:00"; // Winter (CET). In summer, set "+02:00".  [4](https://api.met.no/weatherapi/sunrise/3.0/documentation)

    // Same stop used in both columns (both directions)
    const STOP_A = "NSR:StopPlace:31443";
    const STOP_B = "NSR:StopPlace:31443";

    // TODO: paste your public ICS calendar URL here:
    const CALENDAR_ICS_URL = "https://.../your-shared-calendar.ics";

    /********** CLOCK + DATE (Norwegian) **********/
    function updateClock() {
      const now = new Date();
      const time = now.toLocaleTimeString("no-NO", { hour12: false });
      const dateStr = now.toLocaleDateString("no-NO", { weekday: "long", day: "2-digit", month: "long" });
      document.getElementById("clock").textContent = time;
      document.getElementById("date").textContent = dateStr;
    }
    setInterval(updateClock, 1000); updateClock();

    /********** WEATHER (yr/MET Locationforecast via Worker) **********/
    async function fetchWeather() {
      // MET Locationforecast 2.0 "compact" variant  [2](https://developer.yr.no/doc/locationforecast/HowTO/)
      const url = `https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${LAT.toFixed(4)}&lon=${LON.toFixed(4)}`;
      const res = await fetch(`${WORKER_URL}?url=${encodeURIComponent(url)}`);
      const data = await res.json(); // GeoJSON-like  [6](https://api.met.no/weatherapi/locationforecast/2.0/documentation)

      const ts = data.properties.timeseries;
      const now = ts[0];
      const details = now.data.instant.details;
      const nextHour = ts.find(t => t.data.next_1_hours)?.data?.next_1_hours;

      const temp = Math.round(details.air_temperature);
      const wind = `${Math.round(details.wind_speed)} m/s`;
      const precip = nextHour ? `${(nextHour.details.precipitation_amount || 0).toFixed(1)} mm/1t` : "â€”";
      const symbol = nextHour?.summary?.symbol_code || "â€”";

      document.getElementById("temp").textContent = `${temp}Â°C`;
      document.getElementById("wind").textContent = `Vind ${wind}`;
      document.getElementById("precip").textContent = `NedbÃ¸r ${precip}`;
      document.getElementById("weather-desc").textContent = symbol.replaceAll("_", " ");
      document.getElementById("updated").textContent =
        `Oppdatert ${new Date(data.properties.meta.updated_at).toLocaleTimeString("no-NO",{hour12:false})}`;
    }
    fetchWeather(); setInterval(fetchWeather, 5*60*1000); // cache-friendly per MET guidance  [3](https://developer.yr.no/doc/GettingStarted/)

    /********** SUNRISE / SUNSET (Sunrise 3.0 via Worker) **********/
    async function fetchSun() {
      const today = new Date().toISOString().slice(0,10);
      const url = `https://api.met.no/weatherapi/sunrise/3.0/sun?lat=${LAT}&lon=${LON}&date=${today}&offset=${encodeURIComponent(TIMEZONE_OFFSET)}`; // 3.0  [4](https://api.met.no/weatherapi/sunrise/3.0/documentation)
      const res = await fetch(`${WORKER_URL}?url=${encodeURIComponent(url)}`);
      const data = await res.json();
      const p = data.properties;
      const sunrise = p?.sunrise?.time ? new Date(p.sunrise.time).toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false}) : "â€”";
      const sunset  = p?.sunset ?.time ? new Date(p.sunset .time).toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false}) : "â€”";
      document.getElementById("sunrise").textContent = sunrise;
      document.getElementById("sunset" ).textContent = sunset;
    }
    fetchSun(); setInterval(fetchSun, 12*60*60*1000);

    /********** ENTUR DEPARTURES (direct GraphQL) **********/
    const ENTUR_GRAPHQL = "https://api.entur.io/journey-planner/v3/graphql"; //  [1](https://developer.entur.org/)
    const departuresQuery = `
      query($ids:[String!]!) {
        stopPlaces(ids:$ids) {
          id
          name
          estimatedCalls(timeRange: 7200, numberOfDepartures: 8) {
            realtime
            aimedDepartureTime
            expectedDepartureTime
            destinationDisplay { frontText }
            serviceJourney { journeyPattern { line { transportMode publicCode name } } }
          }
        }
      }`;

    async function fetchDepartures() {
      const ids = [STOP_A, STOP_B];
      const res = await fetch(ENTUR_GRAPHQL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ET-Client-Name": ENTUR_CLIENT_NAME  // identify your app  [1](https://developer.entur.org/)
        },
        body: JSON.stringify({ query: departuresQuery, variables: { ids } })
      });
      const json = await res.json();
      const [A, B] = json.data.stopPlaces;

      function fill(stop, nameId, listId) {
        document.getElementById(nameId).textContent = stop.name;
        const ul = document.getElementById(listId); ul.innerHTML = "";
        stop.estimatedCalls.slice(0, 6).forEach(call => {
          const when = new Date(call.expectedDepartureTime || call.aimedDepartureTime);
          const hhmm = when.toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false});
          const line = call.serviceJourney.journeyPattern.line;
          const li = document.createElement("li");
          const left = document.createElement("span");
          left.textContent = `${line.publicCode ?? ""} ${call.destinationDisplay.frontText}`;
          const right = document.createElement("span");
          right.innerHTML = `${hhmm}${call.realtime ? ' <span class="realtime">â€¢</span>' : ''}`;
          ul.appendChild(li); li.append(left, right);
        });
      }
      fill(A, "stopA-name", "stopA-list");
      fill(B, "stopB-name", "stopB-list");
    }
    fetchDepartures(); setInterval(fetchDepartures, 45*1000); // avoid too-frequent polling  [7](https://www.home-assistant.io/integrations/entur_public_transport/)

    /********** CALENDAR (ICS via Worker) **********/
    async function fetchCalendar() {
      if (!CALENDAR_ICS_URL.startsWith("http")) return;
      const url = `${WORKER_URL}?url=${encodeURIComponent(CALENDAR_ICS_URL)}`;
      const txt = await (await fetch(url)).text();
      const jcal = ICAL.parse(txt); // ICAL.js  [5](https://github.com/kewisch/ical.js/)
      const comp = new ICAL.Component(jcal);
      const events = comp.getAllSubcomponents("vevent").map(v => new ICAL.Event(v));

      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const tomorrow = new Date(today.getTime() + 24*60*60*1000);

      function inRange(s,e,ds,de){return (s<de)&&(e>ds);}
      function render(dayStart, id) {
        const dayEnd = new Date(dayStart.getTime()+24*60*60*1000);
        const box = document.getElementById(id); box.innerHTML = "";
