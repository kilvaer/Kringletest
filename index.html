<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Familiedashboard â€“ Kringlebotn</title>
  <style>
    :root { --bg:#0b132b; --fg:#f0f4f8; --muted:#cbd5e1; --accent:#5bc0be; --warn:#ffd166; }
    html,body{
      height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans","Apple Color Emoji","Noto Color Emoji",sans-serif;
    }
    .grid{
      display:grid; grid-template-columns:1.2fr 1fr; grid-template-rows:auto auto 1fr;
      gap:16px; padding:24px;
    }
    header{
      grid-column:1 / span 2; display:flex; justify-content:space-between; align-items:baseline;
      border-bottom:1px solid #1f2937; padding-bottom:8px;
    }
    .clock{ font-size:64px; font-weight:700; letter-spacing:2px; }
    .date { font-size:24px; color:var(--muted); }
    section{ background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; }
    h2{ margin:0 0 12px; font-size:20px; color:var(--accent); }
    .departures{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .dep-list{ list-style:none; margin:0; padding:0; font-size:18px; }
    .dep-list li{ display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px dashed #243044; }
    .realtime{ font-weight:600; color:#a7f3d0; }
    .sun{ display:flex; gap:24px; }
    .center { display:flex; justify-content:center; }
    .img-responsive { max-width:100%; height:auto; border-radius:8px; }
    @media (max-width:1024px){ .grid{ grid-template-columns:1fr; grid-template-rows:auto; } }
  </style>
</head>
<body>
  <div class="grid">
    <header>
      <div class="clock" id="clock">--:--:--</div>
      <div class="date" id="date">â€”</div>
    </header>

    <!-- Meteogram fra Yr (mÃ¸rk), auto-oppdateres hver 30. min) -->
    <section id="weather">
      <h2>VÃ¦r â€“ Kringlebotn (meteogram fra yr.no)</h2>
      <div class="center">
        <img
         .no/nb/innhold/11-31443/meteogram.svg?mode=dark
      </div>
    </section>

    <section id="sun">
      <h2>Sol i dag</h2>
      <div class="sun">
        <div>ðŸŒ… Soloppgang: <span id="sunrise">â€”</span></div>
        <div>ðŸŒ‡ Solnedgang: <span id="sunset">â€”</span></div>
      </div>
    </section>

    <section id="departures">
      <h2>Buss Kringlebotn</h2>
      <div class="departures">
        <div>
          <div class="small" id="stopA-name">â€”</div>
          <ul class="dep-list" id="stopA-list"></ul>
        </div>
        <div>
          <div class="small" id="stopB-name">â€”</div>
          <ul class="dep-list" id="stopB-list"></ul>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    /********** KONFIG **********/
    const ENTUR_CLIENT_NAME = "KilvaerFamilyDashboard/1.0 (contact: hkilvaer@gmail.com)"; // Entur krever identifikasjon [2](https://wordpress.org/support/topic/trying-to-use-the-embed-url-to-work-with-the-norwegian-weather-forecast-yr-no/)
    const WORKER_URL = "https://raspy-limit-f41d.hkilvaer.workers.dev";                   // Din Cloudflare Worker (proxy)
    // Kringlebotn (Bergen)
    const LAT = 60.33;
    const LON = 5.37;

    // Bruk Quay-IDer (plattform-ID) for retning â€“ mest robust
    const QUAY_A = "NSR:Quay:54147";  // kolonne venstre
    const QUAY_B = "NSR:Quay:54149";  // kolonne hÃ¸yre

    /********** KLOKKE/DATO **********/
    function updateClock() {
      const now = new Date();
      document.getElementById("clock").textContent = now.toLocaleTimeString("no-NO", { hour12: false });
      document.getElementById("date").textContent  = now.toLocaleDateString("no-NO", { weekday: "long", day: "2-digit", month: "long" });
    }
    setInterval(updateClock, 1000); updateClock();

    /********** METEOGRAM AUTO-REFRESH (30 min) **********/
    (function setupMeteogramAutoRefresh(){
      const img = document.getElementById("meteogram");
      const base = "https://www.yr.no/nb/innhold/11-31443/meteogram.svg?mode=dark"; // Yr widget-URL (mÃ¸rk) [1](https://stoppested.entur.org/stop_place/NSR:StopPlace:762)
      function refreshMeteogram(){
        const bucket = Math.floor(Date.now() / (30 * 60 * 1000)); // 30-minutters bucket
        img.src = `${base}&t=${bucket}`;
      }
      setInterval(refreshMeteogram, 30 * 60 * 1000);
    })();

    /********** SUNRISE 3.0 (via Worker, auto lokal offset) **********/
    function getLocalOffsetISO(date = new Date()) {
      const minutesWest = date.getTimezoneOffset(); // minutter VEST for UTC
      const total = -minutesWest;                   // Ã¸st for UTC positivt
      const sign = total >= 0 ? '+' : '-';
      const abs = Math.abs(total);
      const hh = String(Math.floor(abs / 60)).padStart(2,'0');
      const mm = String(abs % 60).padStart(2,'0');
      return `${sign}${hh}:${mm}`;
    }
    async function fetchSun() {
      const today = new Date();
      const dateISO = today.toISOString().slice(0,10);
      const offset = getLocalOffsetISO(today);
      const url = `https://api.met.no/weatherapi/sunrise/3.0/sun?lat=${LAT}&lon=${LON}&date=${dateISO}&offset=${encodeURIComponent(offset)}`; // [1](https://stoppested.entur.org/stop_place/NSR:StopPlace:762)
      try {
        const res = await fetch(`${WORKER_URL}?url=${encodeURIComponent(url)}`);
        if (!res.ok) throw new Error(`Sunrise HTTP ${res.status}`);
        const data = await res.json();
        const p = data?.properties ?? {};
        const sunriseISO = p?.sunrise?.time || null;
        const sunsetISO  = p?.sunset ?.time || null;
        document.getElementById("sunrise").textContent =
          sunriseISO ? new Date(sunriseISO).toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false}) : "â€”";
        document.getElementById("sunset").textContent =
          sunsetISO  ? new Date(sunsetISO ).toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false}) : "â€”";
      } catch (e) {
        console.error("[Sunrise]", e);
        document.getElementById("sunrise").textContent = "â€”";
        document.getElementById("sunset").textContent  = "â€”";
      }
    }
    fetchSun(); setInterval(fetchSun, 12 * 60 * 60 * 1000);

    /********** ENTUR AVGANGER â€“ Quay per kolonne (via Worker) **********/
    const ENTUR_GRAPHQL = "https://api.entur.io/journey-planner/v3/graphql"; // [2](https://wordpress.org/support/topic/trying-to-use-the-embed-url-to-work-with-the-norwegian-weather-forecast-yr-no/)
    const departuresQuayQuery = `
      query($ids:[String!]!) {
        quays(ids:$ids) {
          id
          name
          stopPlace { name }
          estimatedCalls(timeRange: 14400, numberOfDepartures: 12) {
            realtime
            aimedDepartureTime
            expectedDepartureTime
            destinationDisplay { frontText }
            serviceJourney { journeyPattern { line { publicCode name } } }
          }
        }
      }`;

    function labelFromCalls(calls, fallbackName) {
      const first = (calls?.[0]?.destinationDisplay?.frontText || "").trim();
      return first ? `mot ${first}` : (fallbackName || "Kringlebotn");
    }

    function fillList(headerText, calls, nameId, listId) {
      document.getElementById(nameId).textContent = headerText;
      const ul = document.getElementById(listId);
      ul.innerHTML = "";
      if (!calls?.length) {
        const li = document.createElement("li");
        li.textContent = "Ingen avganger";
        ul.appendChild(li);
        return;
      }
      calls.slice(0, 8).forEach(call => {
        const when = new Date(call.expectedDepartureTime || call.aimedDepartureTime);
        const hhmm = isNaN(when) ? "â€”" : when.toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false});
        const line = call.serviceJourney?.journeyPattern?.line || {};
        const li = document.createElement("li");
        const left = document.createElement("span");
        left.textContent = `${line.publicCode ?? ""} ${call.destinationDisplay?.frontText ?? ""}`.trim();
        const right = document.createElement("span");
        right.innerHTML = `${hhmm}${call.realtime ? ' <span class="realtime">â€¢</span>' : ''}`;
        li.append(left, right);
        ul.appendChild(li);
      });
    }

    async function fetchDepartures() {
      try {
        const res = await fetch(
          `${WORKER_URL}?url=${encodeURIComponent(ENTUR_GRAPHQL)}`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "ET-Client-Name": ENTUR_CLIENT_NAME  // Entur krever identifikasjon [2](https://wordpress.org/support/topic/trying-to-use-the-embed-url-to-work-with-the-norwegian-weather-forecast-yr-no/)
            },
            body: JSON.stringify({
              query: departuresQuayQuery,
              variables: { ids: [QUAY_A, QUAY_B] }
            })
          }
        );

        if (!res.ok) {
          const text = await res.text();
          console.error(`[Entur] HTTP ${res.status}`, text);
          return;
        }

        const json = await res.json();
        if (json.errors) {
          console.error("[Entur] GraphQL errors:", json.errors);
          return;
        }

        const quays = json?.data?.quays || [];
        if (quays.length === 0) {
          console.warn("[Entur] Tomt svar â€“ sjekk Quay-IDene.");
          return;
        }

        const QA = quays[0], QB = quays[1];
        const headerA = labelFromCalls(QA?.estimatedCalls, QA?.stopPlace?.name || QA?.name);
        const headerB = labelFromCalls(QB?.estimatedCalls, QB?.stopPlace?.name || QB?.name);

        fillList(headerA, QA?.estimatedCalls, "stopA-name", "stopA-list");
        fillList(headerB, QB?.estimatedCalls, "stopB-name", "stopB-list");
      } catch (e) {
        console.error("[Entur] Unntak:", e);
      }
    }
    fetchDepartures(); setInterval(fetchDepartures, 45 * 1000); // ikke poll hyppigere (Entur best-practice) [2](https://wordpress.org/support/topic/trying-to-use-the-embed-url-to-work-with-the-norwegian-weather-forecast-yr-no/)
  </script>
</body>
</html>