<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Familiedashboard â€“ Kringlebotn</title>
  <style>
    :root { --bg:#0b132b; --fg:#f0f4f8; --muted:#cbd5e1; --accent:#5bc0be; --warn:#ffd166; }
    html,body{
      height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans","Apple Color Emoji","Noto Color Emoji",sans-serif;
    }
    .grid{
      display:grid; grid-template-columns:1.2fr 1fr; grid-template-rows:auto auto 1fr;
      gap:16px; padding:24px;
    }
    header{
      grid-column:1 / span 2; display:flex; justify-content:space-between; align-items:baseline;
      border-bottom:1px solid #1f2937; padding-bottom:8px;
    }
    .clock{ font-size:64px; font-weight:700; letter-spacing:2px; }
    .date { font-size:24px; color:var(--muted); }
    section{ background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; }
    h2{ margin:0 0 12px; font-size:20px; color:var(--accent); }
    .departures{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .dep-list{ list-style:none; margin:0; padding:0; font-size:18px; }
    .dep-list li{ display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px dashed #243044; }
    .realtime{ font-weight:600; color:#a7f3d0; }
    .calendar{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .cal-day h3{ margin:0 0 8px; font-size:18px; color:var(--muted); }
    .event{ padding:6px 8px; border-left:4px solid #334155; margin:6px 0; background:#0f172a; border-radius:6px; }
    .sun{ display:flex; gap:24px; }
    .center { display:flex; justify-content:center; }
    .img-responsive { max-width:100%; height:auto; border-radius:8px; }
    @media (max-width:1024px){ .grid{ grid-template-columns:1fr; grid-template-rows:auto; } }
  </style>
</head>
<body>
  <div class="grid">
    <header>
      <div class="clock" id="clock">--:--:--</div>
      <div class="date" id="date">â€”</div>
    </header>

    <!-- Meteogram fra Yr (mÃ¸rk modus), auto-oppdateres hver 30. min -->
    <section id="weather">
      <h2>VÃ¦r â€“ Kringlebotn (meteogram fra yr.no)</h2>
      <div class="center">
        <img
          id="meteogram"
          src="https://www.yr.no/nb/innhold/11-31443/meteogram.svg?mode=dark"
          alt="Meteogram fra yr.no for Kringlebotn"
          class="img-responsive"
          referrer</span></div>
        <div>ðŸŒ… Soloppgang: <span id="sunrise">â€”</span></div>
        <div>ðŸŒ‡ Solnedgang: <span id="sunset">â€”</span></div>
      </div>
    </section>

    <section id="departures">
      <h2>Avganger â€“ Kringlebotn</h2>
      <div class="departures">
        <div>
          <div class="small" id="stopA-name">â€”</div>
          <ul class="dep-list" id="stopA-list"></ul>
        </div>
        <div>
          <div class="small" id="stopB-name">â€”</div>
          <ul class="dep-list" id="stopB-list"></ul>
        </div>
      </div>
    </section>

    <section id="calendar">
      <h2>Familiekalender</h2>
      <div class="calendar">
        <div class="cal-day">
          <h3>I dag</h3>
          <div id="events-today">Ingen hendelser</div>
        </div>
        <div class="cal-day">
          <h3>I morgen</h3>
          <div id="events-tomorrow">Ingen hendelser</div>
        </div>
      </div>
    </section>
  </div>

  <!-- ICAL.js (kun brukt for kalender) -->
  <script type="module">
    import ICAL from "https://unpkg.com/ical.js/dist/ical.min.js";

    /********** KONFIG **********/
    const ENTUR_CLIENT_NAME = "KilvaerFamilyDashboard â€“ contact: hkilvaer@gmail.com"; // Entur krever identifikasjon  (docs: https://developer.entur.org/) 
    const WORKER_URL = "https://raspy-limit-f41d.hkilvaer.workers.dev";               // Worker for Sunrise & ICS
    const LAT = 60.33;
    const LON = 5.37;
    const TIMEZONE_OFFSET = "+01:00"; // CET; bytt til "+02:00" i sommerhalvÃ¥ret (si fra hvis du vil ha auto-DST)
    const STOP_A = "NSR:StopPlace:31443";
    const STOP_B = "NSR:StopPlace:31443";
    const CALENDAR_ICS_URL = "https://.../your-shared-calendar.ics"; // legg inn nÃ¥r du har URL

    /********** KLOKKE/DATO **********/
    function updateClock() {
      const now = new Date();
      document.getElementById("clock").textContent = now.toLocaleTimeString("no-NO", { hour12: false });
      document.getElementById("date").textContent  = now.toLocaleDateString("no-NO", { weekday: "long", day: "2-digit", month: "long" });
    }
    setInterval(updateClock, 1000); updateClock();

    /********** METEOGRAM AUTO-REFRESH (hver 30. min) **********/
    (function setupMeteogramAutoRefresh(){
      const img = document.getElementById("meteogram");
      const base = "https://www.yr.no/nb/innhold/11-31443/meteogram.svg?mode=dark"; // Yr widget-URL (mÃ¸rk)  [1](https://developer.yr.no/doc/guides/available-widgets/)
      function refreshMeteogram(){
        const bucket = Math.floor(Date.now() / (30 * 60 * 1000)); // 30-minutters "cache-bucket"
        img.src = `${base}&t=${bucket}`;
      }
      setInterval(refreshMeteogram, 30 * 60 * 1000);
    })();

    /********** SUNRISE 3.0 (via Worker) **********/
    async function fetchSun() {
      const today = new Date().toISOString().slice(0,10);
      const url = `https://api.met.no/weatherapi/sunrise/3.0/sun?lat=${LAT}&lon=${LON}&date=${today}&offset=${encodeURIComponent(TIMEZONE_OFFSET)}`; // 3.0 m/offset  [1](https://developer.yr.no/doc/guides/available-widgets/)
      try {
        const res = await fetch(`${WORKER_URL}?url=${encodeURIComponent(url)}`);
        if (!res.ok) throw new Error(`Sunrise HTTP ${res.status}`);
        const data = await res.json();
        const p = data.properties;
        const sunrise = p?.sunrise?.time ? new Date(p.sunrise.time).toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false}) : "â€”";
        const sunset  = p?.sunset ?.time ? new Date(p.sunset .time).toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false}) : "â€”";
        document.getElementById("sunrise").textContent = sunrise;
        document.getElementById("sunset").textContent  = sunset;
      } catch (e) {
        console.error("[Sunrise]", e);
      }
    }
    fetchSun(); setInterval(fetchSun, 12 * 60 * 60 * 1000); // 2 ganger i dÃ¸gnet

    /********** ENTUR AVGANGER (direkte GraphQL) **********/
    const ENTUR_GRAPHQL = "https://api.entur.io/journey-planner/v3/graphql"; //  
    const departuresQuery = `
      query($ids:[String!]!) {
        stopPlaces(ids:$ids) {
          id
          name
          estimatedCalls(timeRange: 7200, numberOfDepartures: 8) {
            realtime
            aimedDepartureTime
            expectedDepartureTime
            destinationDisplay { frontText }
            serviceJourney { journeyPattern { line { transportMode publicCode name } } }
          }
        }
      }`;

    async function fetchDepartures() {
      try {
        const res = await fetch(ENTUR_GRAPHQL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "ET-Client-Name": ENTUR_CLIENT_NAME
          },
          body: JSON.stringify({ query: departuresQuery, variables: { ids: [STOP_A, STOP_B] } })
        });
        if (!res.ok) throw new Error(`Entur HTTP ${res.status}`);
        const json = await res.json();
        const [A, B] = json?.data?.stopPlaces ?? [];
        if (!A && !B) { console.warn("Entur: ingen stopPlaces returnert â€“ sjekk ID."); return; }

        function fill(stop, nameId, listId) {
          const nameEl = document.getElementById(nameId);
          const ul = document.getElementById(listId);
          nameEl.textContent = stop?.name ?? "(ukjent stopp)";
          ul.innerHTML = "";
          (stop?.estimatedCalls ?? []).slice(0,6).forEach(call => {
            const when = new Date(call.expectedDepartureTime || call.aimedDepartureTime);
            const hhmm = isNaN(when) ? "â€”" : when.toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false});
            const line = call.serviceJourney?.journeyPattern?.line || {};
            const li = document.createElement("li");
            const left = document.createElement("span");
            left.textContent = `${line.publicCode ?? ""} ${call.destinationDisplay?.frontText ?? ""}`.trim();
            const right = document.createElement("span");
            right.innerHTML = `${hhmm}${call.realtime ? ' <span class="realtime">â€¢</span>' : ''}`;
            li.append(left, right);
            ul.appendChild(li);
          });
        }
        fill(A ?? B, "stopA-name", "stopA-list");
        fill(B ?? A, "stopB-name", "stopB-list");
      } catch (e) {
        console.error("[Entur]", e);
      }
    }
    fetchDepartures(); setInterval(fetchDepartures, 45 * 1000); // ikke poll raskere  (ref. Entur-integrasjoner)  

    /********** KALENDER (ICS via Worker) **********/
    async function fetchCalendar() {
      if (!CALENDAR_ICS_URL.startsWith("http")) return; // ikke konfigurert ennÃ¥
      try {
        const txt = await (await fetch(`${WORKER_URL}?url=${encodeURIComponent(CALENDAR_ICS_URL)}`)).text();
        const jcal = ICAL.parse(txt);
        const comp = new ICAL.Component(jcal);
        const events = comp.getAllSubcomponents("vevent").map(v => new ICAL.Event(v));

        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const tomorrow = new Date(today.getTime() + 24*60*60*1000);

        function inRange(s,e,ds,de){ return (s < de) && (e > ds); }
        function render(dayStart, id) {
          const dayEnd = new Date(dayStart.getTime()+24*60*60*1000);
          const box = document.getElementById(id); box.innerHTML = "";
          const todays = [];
          for (const e of events) {
            const s = e.startDate.toJSDate();
            const eEnd = e.endDate ? e.endDate.toJSDate() : new Date(s.getTime()+60*60*1000);
            if (inRange(s, eEnd, dayStart, dayEnd)) {
              todays.push({summary:e.summary, start:s, end:eEnd, allDay:e.startDate.isDate});
            }
          }
          if (todays.length === 0) { box.textContent = "Ingen hendelser"; return; }
          todays.sort((a,b)=>a.start-b.start);
          for (const ev of todays) {
            const div = document.createElement("div");
            div.className = "event";
            const time = ev.allDay
              ? "Hele dagen"
              : `${ev.start.toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false})}â€“${ev.end.toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false})}`;
            div.innerHTML = `<strong>${ev.summary || "(uten tittel)"}</strong><br><span class="small">${time}</span>`;
            box.appendChild(div);
          }
        }
        render(today, "events-today");
        render(tomorrow, "events-tomorrow");
      } catch (e) {
        console.error("[Calendar]", e);
      }
    }
    fetchCalendar(); setInterval(fetchCalendar, 10 * 60 * 1000);
  </script>
</body>
</html>

