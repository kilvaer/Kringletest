<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Familiedashboard â€“ Kringlebotn</title>
  <style>
    :root { --bg:#0b132b; --fg:#f0f4f8; --muted:#cbd5e1; --accent:#5bc0be; --warn:#ffd166; --card:#111827; --border:#1f2937; }
    html,body{
      height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans","Apple Color Emoji","Noto Color Emoji",sans-serif;
    }

    /* ====== GRID LAYOUT iht. skissen ====== */
    .grid{
      display:grid;
      gap:12px;                 /* tett og kant-til-kant */
      padding:0;                /* fjern ytre padding */
      grid-template-areas:
        "header header"
        "weather weather"
        "bus     bus"
        "calendar countdowns";
      grid-template-columns:1.2fr 1fr;
      grid-auto-rows:min-content;
    }
    header{ grid-area: header; }
    #weather{ grid-area: weather; }
    #departures{ grid-area: bus; }
    #calendar{ grid-area: calendar; }
    #countdowns{ grid-area: countdowns; }

    /* Stabler i Ã©n kolonne i portrett */
    @media (max-width:1024px){
      .grid{
        grid-template-areas:
          "header"
          "weather"
          "bus"
          "calendar"
          "countdowns";
        grid-template-columns:1fr;
      }
    }

    /* ====== HEADER ====== */
    header{
      display:flex; justify-content:space-between; align-items:baseline;
      border-bottom:1px solid var(--border); padding:8px 12px;
      background:var(--bg);
    }
    .clock{ font-size:64px; font-weight:700; letter-spacing:2px; line-height:1.05; }
    .date { font-size:24px; color:var(--muted); }

    /* ====== KORT ====== */
    section{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; }
    h2{ margin:0 0 12px; font-size:20px; color:var(--accent); }
    .small{ color: var(--muted); font-size:12px; }

    /* ====== VÃ†R ====== */
    .center { display:flex; justify-content:center; }
    .img-responsive { max-width:100%; height:auto; border-radius:8px; display:block; }
    /* Soloppgang/-nedgang vises INNI vÃ¦rkortet */
    #sun{
      display:flex; gap:24px; justify-content:center; align-items:center;
      margin-top:8px; padding-top:6px; border-top:1px dashed var(--border);
      font-size:18px;
    }
    @media (max-width:1024px){ #sun{ flex-wrap:wrap; gap:12px; font-size:16px; } }

    /* ====== BUSS (full bredde, to kolonner med vertikal skillelinje) ====== */
    .departures{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .departures.two-cols > div:first-child{ border-right:1px solid var(--border); padding-right:12px; }
    .departures.two-cols > div:last-child{ padding-left:12px; }
    @media (max-width:1024px){
      .departures{ grid-template-columns:1fr; }
      .departures.two-cols > div:first-child{ border-right:none; padding-right:0; }
      .departures.two-cols > div:last-child{ padding-left:0; }
    }
    .dep-list{ list-style:none; margin:0; padding:0; font-size:18px; }
    .dep-list li{ display:flex; justify-content:space-between; align-items:baseline; padding:6px 0; border-bottom:1px dashed #243044; }
    .realtime{ font-weight:600; color:#a7f3d0; }

    /* ====== KALENDER ====== */
    .calendar{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:1024px){ .calendar{ grid-template-columns:1fr; } }
    .cal-day h3{ margin:0 0 8px; font-size:18px; color:var(--muted); }
    .event{ padding:6px 8px; border-left:4px solid #334155; margin:6px 0; background:#0f172a; border-radius:6px; }

    /* ====== NEDTELLINGER ====== */
    #countdowns h2 { color: var(--accent); margin: 0 0 12px; font-size:20px; }
    #countdowns-list { list-style:none; margin:0; padding:0; }
    #countdowns-list li { padding: 6px 0; border-bottom: 1px dashed #243044; }
  </style>
</head>
<body>
  <div class="grid">
    <!-- HEADER -->
    <header>
      <div class="clock" id="clock">--:--:--</div>
      <div class="date" id="date">â€”</div>
    </header>

    <!-- VÃ†R (meteogram + soloppgang/solnedgang INNI kortet) -->
    <section id="weather">
      <!-- <h2>VÃ¦r â€“ Kringlebotn</h2> -->
      <div class="center">
        <img
          id="meteogram"
          src="https://www.yr.no/nb/innhold/11-31443/meteogram.svg?mode=dark"
          alt="Meteogram fra yr.no for Kringlebotn"
          class="img-responsive"
          refset">â€”</strong></div>
      </div>
    </section>

    <!-- BUSS (full bredde, to kolonner) -->
    <section id="departures">
      <h2>Buss Kringlebotn</h2>
      <div class="departures two-cols" id="departures-grid">
        <div>
          <div class="small" id="stopA-name">â€”</div>
          <ul class="dep-list" id="stopA-list"></ul>
        </div>
        <div>
          <div class="small" id="stopB-name">â€”</div>
          <ul class="dep-list" id="stopB-list"></ul>
        </div>
      </div>
    </section>

    <!-- KALENDER (venstre nede) -->
    <section id="calendar">
      <!-- <h2>Familiekalender</h2> -->
      <div class="calendar">
        <div class="cal-day">
          <h3>I dag</h3>
          <div id="events-today">Ingen hendelser</div>
        </div>
        <div class="cal-day">
          <h3>I morgen</h3>
          <div id="events-tomorrow">Ingen hendelser</div>
        </div>
      </div>
    </section>

    <!-- NEDTELLINGER (hÃ¸yre nede) -->
    <section id="countdowns">
      <!-- <h2>Nedtellinger</h2> -->
      <ul id="countdowns-list"></ul>
    </section>
  </div>

  <!-- ICAL.js brukes kun for kalenderen -->
  <script type="module">
    import ICAL from "https://unpkg.com/ical.js/dist/ical.min.js";

    /********** KONFIG **********/
    const ENTUR_CLIENT_NAME = "Kringlebotn-Dashboard (owner: hkilvaer@gmail.com)";
    const WORKER_URL = "https://raspy-limit-f41d.hkilvaer.workers.dev";
    const LAT = 60.33;
    const LON = 5.37;

    // Quay-IDer (plattform/retning)
    const QUAY_A = "NSR:Quay:54147";  // venstre kolonne â€“ mot Nesttun
    const QUAY_B = "NSR:Quay:54149";  // hÃ¸yre kolonne â€“ mot Ã˜yjorden

    // Kalender (kan stÃ¥ tom)
    const CALENDAR_ICS_URL = `${WORKER_URL}/icloud`;
    const HOLIDAYS_ICS_URL = `${WORKER_URL}/holidays`;

    /********** KLOKKE/DATO **********/
    function updateClock() {
      const now = new Date();
      document.getElementById("clock").textContent = now.toLocaleTimeString("no-NO", { hour12: false });
      document.getElementById("date").textContent  = now.toLocaleDateString("no-NO", { weekday: "long", day: "2-digit", month: "long" });
    }
    setInterval(updateClock, 1000); updateClock();

    /********** METEOGRAM AUTO-REFRESH (30 min) **********/
    (function setupMeteogramAutoRefresh(){
      const img = document.getElementById("meteogram");
      const base = "https://www.yr.no/nb/innhold/11-31443/meteogram.svg?mode=dark";
      function refreshMeteogram(){
        const bucket = Math.floor(Date.now() / (30 * 60 * 1000)); // 30-minutters bucket
        img.src = `${base}&t=${bucket}`;
      }
      setInterval(refreshMeteogram, 30 * 60 * 1000);
    })();

    /********** SUNRISE 3.0 (via Worker, auto lokal offset) **********/
    function getLocalOffsetISO(date = new Date()) {
      const minutesWest = date.getTimezoneOffset();
      const total = -minutesWest; // Ã¸st for UTC positivt
      const sign = total >= 0 ? '+' : '-';
      const abs = Math.abs(total);
      const hh = String(Math.floor(abs / 60)).padStart(2,'0');
      const mm = String(abs % 60).padStart(2,'0');
      return `${sign}${hh}:${mm}`;
    }

    async function fetchSun() {
      const today = new Date();
      const dateISO = today.toISOString().slice(0,10);
      const offset = getLocalOffsetISO(today);

      const url = `https://api.met.no/weatherapi/sunrise/3.0/sun?lat=${LAT}&lon=${LON}&date=${dateISO}&offset=${encodeURIComponent(offset)}`;
      try {
        const res = await fetch(`${WORKER_URL}?url=${encodeURIComponent(url)}`);
        if (!res.ok) throw new Error(`Sunrise HTTP ${res.status}`);
        const data = await res.json();

        const p = data?.properties ?? {};
        const sunriseISO = p?.sunrise?.time || null;
        const sunsetISO  = p?.sunset ?.time || null;

        const sunriseText = sunriseISO
          ? new Date(sunriseISO).toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false})
          : "â€”";
        const sunsetText  = sunsetISO
          ? new Date(sunsetISO).toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false})
          : "â€”";

        document.getElementById("sunrise").textContent = sunriseText;
        document.getElementById("sunset").textContent  = sunsetText;
      } catch (e) {
        console.error("[Sunrise] Feil ved henting/parsing:", e);
        document.getElementById("sunrise").textContent = "â€”";
        document.getElementById("sunset").textContent  = "â€”";
      }
    }
    fetchSun(); setInterval(fetchSun, 12 * 60 * 60 * 1000);

    /********** ENTUR AVGANGER â€“ Quay per kolonne (via Worker) **********/
    const ENTUR_GRAPHQL = "https://api.entur.io/journey-planner/v3/graphql";
    const departuresQuayQuery = `
      query($ids:[String!]!) {
        quays(ids:$ids) {
          id
          name
          stopPlace { name }
          estimatedCalls(timeRange: 14400, numberOfDepartures: 12) {
            realtime
            aimedDepartureTime
            expectedDepartureTime
            destinationDisplay { frontText }
            serviceJourney { journeyPattern { line { publicCode name } } }
          }
        }
      }`;

    function autoHeader(calls, fallback = "mot â€”") {
      if (!calls || !calls.length) return fallback;
      const dest = calls[0]?.destinationDisplay?.frontText;
      return dest && dest.trim() ? `mot ${dest.trim()}` : fallback;
    }

    function fillList(headerText, calls, nameId, listId) {
      document.getElementById(nameId).textContent = headerText;
      const ul = document.getElementById(listId);
      ul.innerHTML = "";
      if (!calls?.length) {
        const li = document.createElement("li");
        li.textContent = "Ingen avganger";
        ul.appendChild(li);
        return;
      }
      calls.slice(0, 4).forEach(call => {
        const when = new Date(call.expectedDepartureTime || call.aimedDepartureTime);
        const now  = new Date();
        const mins = Math.max(0, Math.round((when - now) / 60000)); // minutter til avgang
        const hhmm = isNaN(when) ? "â€”" : when.toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false});

        const li = document.createElement("li");
        const left = document.createElement("span");
        left.textContent = "";

        const right = document.createElement("span");
        right.innerHTML = `${hhmm}  <span class="small">(${mins} min)</span>${call.realtime ? ' <span class="realtime">â€¢</span>' : ''}`;

        li.append(left, right);
        ul.appendChild(li);
      });
    }

    async function fetchDepartures() {
      try {
        const res = await fetch(
          `${WORKER_URL}?url=${encodeURIComponent(ENTUR_GRAPHQL)}`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "ET-Client-Name": ENTUR_CLIENT_NAME
            },
            body: JSON.stringify({
              query: departuresQuayQuery,
              variables: { ids: [QUAY_A, QUAY_B] }
            })
          }
        );

        if (!res.ok) {
          const text = await res.text();
          console.error(`[Entur] HTTP ${res.status}`, text);
          return;
        }
        const json = await res.json();
        if (json.errors) {
          console.error("[Entur] GraphQL errors:", json.errors);
          return;
        }

        const quays = json?.data?.quays || [];
        if (quays.length < 2) {
          console.warn("[Entur] Mangler en av Quay-ene â€“ sjekk IDene.");
          return;
        }

        const QA = quays[0];
        const QB = quays[1];

        const headerA = `${autoHeader(QA?.estimatedCalls)}`;
        const headerB = `${autoHeader(QB?.estimatedCalls)}`;

        fillList(headerA, QA?.estimatedCalls, "stopA-name", "stopA-list");
        fillList(headerB, QB?.estimatedCalls, "stopB-name", "stopB-list");
      } catch (e) {
        console.error("[Entur] Unntak:", e);
      }
    }
    fetchDepartures(); setInterval(fetchDepartures, 45 * 1000);

    /********** KALENDER (ICS via Worker) **********/
    async function fetchCalendar() {
      try {
        const [txtFam, txtHol] = await Promise.all([
          fetch(CALENDAR_ICS_URL).then(r => r.text()),
          fetch(HOLIDAYS_ICS_URL).then(r => r.text())
        ]);

        const famJcal = ICAL.parse(txtFam);
        const famComp = new ICAL.Component(famJcal);
        const famEvents = famComp.getAllSubcomponents("vevent")
          .map(v => {
            const e = new ICAL.Event(v);
            return { src: "fam", e };
          });

        const holJcal = ICAL.parse(txtHol);
        const holComp = new ICAL.Component(holJcal);
        const holEvents = holComp.getAllSubcomponents("vevent")
          .map(v => {
            const e = new ICAL.Event(v);
            return { src: "hol", e };
          });

        const all = [...famEvents, ...holEvents];
        const dedupMap = new Map();
        for (const { src, e } of all) {
          const startISO = e.startDate?.toJSDate()?.toISOString?.() ?? "";
          const key = `${(e.summary || "").trim()}__${startISO}`;
          if (!dedupMap.has(key)) dedupMap.set(key, { src, e });
        }
        const merged = Array.from(dedupMap.values());

        const startOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());
        const now = new Date();
        const today = startOfDay(now);
        const tomorrow = new Date(today.getTime() + 24*60*60*1000);
        const dayEnd = (d) => new Date(d.getTime() + 24*60*60*1000);

        const occurInRange = (s, e, ds, de) => (s < de) && (e > ds);

        function toRow({ src, e }) {
          const s = e.startDate.toJSDate();
          const end = e.endDate ? e.endDate.toJSDate() : new Date(s.getTime() + 60*60*1000);
          const allDay = e.startDate.isDate;
          const timeText = allDay
            ? "Hele dagen"
            : `${s.toLocaleTimeString("no-NO", {hour:"2-digit",minute:"2-digit",hour12:false})}â€“${end.toLocaleTimeString("no-NO", {hour:"2-digit",minute:"2-digit",hour12:false})}`;

          const badge = src === "hol" ? '<span class="small" style="color:#94a3b8">[merkedag]</span>' : '';
          return {
            start: s,
            html: `<div class="event"><strong>${e.summary || "(uten tittel)"}</strong> ${badge}<br><span class="small">${timeText}</span></div>`
          };
        }

        function renderDay(dayStart, boxId) {
          const dayBox = document.getElementById(boxId);
          dayBox.innerHTML = "";
          const dayEvents = merged
            .filter(({ e }) => {
              const s = e.startDate.toJSDate();
              const end = e.endDate ? e.endDate.toJSDate() : new Date(s.getTime() + 60*60*1000);
              return occurInRange(s, end, dayStart, dayEnd(dayStart));
            })
            .map(toRow)
            .sort((a,b) => a.start - b.start);

          if (dayEvents.length === 0) {
            dayBox.textContent = "Ingen hendelser";
            return;
          }
          for (const row of dayEvents) {
            const div = document.createElement("div");
            div.innerHTML = row.html;
            dayBox.appendChild(div.firstChild);
          }
        }

        renderDay(today, "events-today");
        renderDay(tomorrow, "events-tomorrow");
      } catch (e) {
        console.error("[Calendar merge]", e);
        const t = document.getElementById("events-today");
        const m = document.getElementById("events-tomorrow");
        if (t) t.textContent = "Kunne ikke laste kalender";
        if (m) m.textContent = "â€”";
      }
    }
    fetchCalendar(); setInterval(fetchCalendar, 10 * 60 * 1000);

    /********** GITHUB â€“ siste commit (uendret) **********/
    async function fetchLastCommit() {
      const API = "https://api.github.com/repos/kilvaer/Kringletest/commits?path=index.html&sha=main&per_page=1";
      const el = document.getElementById("last-commit");
      try {
        const res = await fetch(API, { headers: { "Accept": "application/vnd.github+json" } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const c = data?.[0];
        if (!c) { el.textContent = "ukjent"; return; }

        const hash = c.sha.slice(0,7);
        const when = new Date(c.commit.author.date);
        const dato = when.toLocaleDateString("no-NO", { weekday:"long", day:"2-digit", month:"long", year:"numeric" });
        const klokke = when.toLocaleTimeString("no-NO", { hour:"2-digit", minute:"2-digit", second:"2-digit", hour12:false });

        el.textContent = `${hash} â€“ ${dato} kl. ${klokke}`;
      } catch (e) {
        console.error("[CommitInfo]", e);
        el.textContent = "ukjent";
      }
    }
    fetchLastCommit();

    /* ===========================
           NEDTELLINGER (inline)
       =========================== */
    const COUNTDOWN_EVENTS = [
      { name: "ðŸ§œðŸ¼â€â™€ï¸Eva",   day: 14, month: 3  },
      { name: "ðŸ§ðŸ¼Nora",     day: 30, month: 5  },
      { name: "ðŸ‘¨ðŸ¼â€ðŸš€Pappa",  day: 5,  month: 8  },
      { name: "ðŸ‘¸ðŸ¼Mamma",    day: 19, month: 8  },
      { name: "ðŸŽ„ðŸŽðŸŽ…ðŸ¼",      day: 24, month: 12 }
    ];
    const MONTHS_NO = [
      "januar","februar","mars","april","mai","juni",
      "juli","august","september","oktober","november","desember"
    ];
    function stripTime(d) { return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
    function nextOccurrence(day, month, now = new Date()) {
      const y = now.getFullYear();
      const thisYear = new Date(y, month - 1, day, 23, 59, 59, 999);
      if (thisYear >= stripTime(now)) return thisYear;
      return new Date(y + 1, month - 1, day, 23, 59, 59, 999);
    }
    function diffDays(futureDate, now = new Date()) {
      const ms = stripTime(futureDate) - stripTime(now);
      return Math.round(ms / (1000 * 60 * 60 * 24));
    }
    function formatCountdownRow(evt, now = new Date()) {
      const next = nextOccurrence(evt.day, evt.month, now);
      const days = diffDays(next, now);
      const daysText = (days === 0) ? "i dag" : (days === 1) ? "om 1 dag" : `om ${days} dager`;
      const datoText = `${evt.day}. ${MONTHS_NO[evt.month - 1]}`;
      return { days, html: `<strong>${evt.name}</strong> â€“ ${datoText} <span class="small">(${daysText})</span>` };
    }
    function renderCountdowns() {
      const listEl = document.getElementById("countdowns-list");
      if (!listEl) return;
      const now = new Date();
      const rows = COUNTDOWN_EVENTS
        .map(evt => formatCountdownRow(evt, now))
        .sort((a, b) => a.days - b.days);
      listEl.innerHTML = "";
      for (const row of rows) {
        const li = document.createElement("li");
        li.innerHTML = row.html;
        listEl.appendChild(li);
      }
    }
    renderCountdowns();
    (function scheduleMidnightRefresh() {
      const now = new Date();
      const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
      const msToMidnight = midnight - now;
      setTimeout(() => {
        renderCountdowns();
        setInterval(renderCountdowns, 24 * 60 * 60 * 1000);
      }, msToMidnight);
    })();
  </script>

  <footer id="build-info" style="margin: 8px 12px; color:#94a3b8; font-size:12px;">
    Sist oppdatert fra commit: <span id="last-commit">lasterâ€¦</span>
  </footer>
</body>
</html>
