<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Familiedashboard â€“ Kringlebotn</title>
  <style>
    :root { --bg:#0b132b; --fg:#f0f4f8; --muted:#cbd5e1; --accent:#5bc0be; --warn:#ffd166; }
    html,body{
      height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans","Apple Color Emoji","Noto Color Emoji",sans-serif;
    }
    .grid{
      display:grid; grid-template-columns:1.2fr 1fr; grid-template-rows:auto auto 1fr;
      gap:16px; padding:24px;
    }
    header{
      grid-column:1 / span 2; display:flex; justify-content:space-between; align-items:baseline;
      border-bottom:1px solid #1f2937; padding-bottom:8px;
    }
    .clock{ font-size:64px; font-weight:700; letter-spacing:2px; }
    .date { font-size:24px; color:var(--muted); }
    section{ background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; }
    h2{ margin:0 0 12px; font-size:20px; color:var(--accent); }
    .departures{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .dep-list{ list-style:none; margin:0; padding:0; font-size:18px; }
    .dep-list li{ display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px dashed #243044; }
    .realtime{ font-weight:600; color:#a7f3d0; }
    .calendar{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .cal-day h3{ margin:0 0 8px; font-size:18px; color:var(--muted); }
    .event{ padding:6px 8px; border-left:4px solid #334155; margin:6px 0; background:#0f172a; border-radius:6px; }
    .sun{ display:flex; gap:24px; }
    .center { display:flex; justify-content:center; }
    .img-responsive { max-width:100%; height:auto; border-radius:8px; }
    @media (max-width:1024px){ .grid{ grid-template-columns:1fr; grid-template-rows:auto; } }
  </style>
</head>
<body>
  <div class="grid">
    <header>
      <div class="clock" id="clock">--:--:--</div>
      <div class="date" id="date">â€”</div>
    </header>

    <!-- Meteogram fra Yr (mÃ¸rk), auto-oppdateres hver 30. min -->
    <section id="weather">
      <h2>VÃ¦r â€“ Kringlebotn (meteogram fra yr.no)</h2>
      <div class="center">
        <img
          id="meteogram"
          src="https://www.yr.no/nb/innhold/11-31443/meteogram.svg?mode=dark"
          alt="Meteogram fra yr.no for Kringles="sun">
        <div>ðŸŒ… Soloppgang: <span id="sunrise">â€”</span></div>
        <div>ðŸŒ‡ Solnedgang: <span id="sunset">â€”</span></div>
      </div>
    </section>

    <section id="departures">
      <h2>Avganger â€“ Kringlebotn</h2>
      <div class="departures">
        <div>
          <div class="small" id="stopA-name">â€”</div>
          <ul class="dep-list" id="stopA-list"></ul>
        </div>
        <div>
          <div class="small" id="stopB-name">â€”</div>
          <ul class="dep-list" id="stopB-list"></ul>
        </div>
      </div>
    </section>

    <section id="calendar">
      <h2>Familiekalender</h2>
      <div class="calendar">
        <div class="cal-day">
          <h3>I dag</h3>
          <div id="events-today">Ingen hendelser</div>
        </div>
        <div class="cal-day">
          <h3>I morgen</h3>
          <div id="events-tomorrow">Ingen hendelser</div>
        </div>
      </div>
    </section>
  </div>

  <!-- ICAL.js brukes kun for kalenderen -->
  <script type="module">
    import ICAL from "https://unpkg.com/ical.js/dist/ical.min.js";

    /********** KONFIG **********/
    const ENTUR_CLIENT_NAME = "Kringlebotn-Dashboard (owner: hkilvaer@gmail.com)";
    const WORKER_URL = "https://raspy-limit-f41d.hkilvaer.workers.dev";
    const LAT = 60.33;
    const LON = 5.37;
    const STOP_A = "NSR:Quay:54147"; // kolonne A
    const STOP_B = "NSR:Quay:54149"; // kolonne B

    const CALENDAR_ICS_URL = "https://.../your-shared-calendar.ics"; // legg inn nÃ¥r du har URL

    /********** KLOKKE/DATO **********/
    function updateClock() {
      const now = new Date();
      document.getElementById("clock").textContent = now.toLocaleTimeString("no-NO", { hour12: false });
      document.getElementById("date").textContent  = now.toLocaleDateString("no-NO", { weekday: "long", day: "2-digit", month: "long" });
    }
    setInterval(updateClock, 1000); updateClock();

    /********** METEOGRAM AUTO-REFRESH (30 min) **********/
    (function setupMeteogramAutoRefresh(){
      const img = document.getElementById("meteogram");
      const base = "https://www.yr.no/nb/innhold/11-31443/meteogram.svg?mode=dark";
      function refreshMeteogram(){
        const bucket = Math.floor(Date.now() / (30 * 60 * 1000)); // 30-minutters bucket
        img.src = `${base}&t=${bucket}`;
      }
      setInterval(refreshMeteogram, 30 * 60 * 1000);
    })();

    /********** SUNRISE 3.0 (via Worker, auto lokal offset) **********/
    function getLocalOffsetISO(date = new Date()) {
      const minutesWest = date.getTimezoneOffset(); // minutter VEST for UTC
      const total = -minutesWest;                   // Ã¸st for UTC positivt
      const sign = total >= 0 ? '+' : '-';
      const abs = Math.abs(total);
      const hh = String(Math.floor(abs / 60)).padStart(2,'0');
      const mm = String(abs % 60).padStart(2,'0');
      return `${sign}${hh}:${mm}`; // "+01:00" eller "+02:00"
    }

    async function fetchSun() {
      const today = new Date();
      const dateISO = today.toISOString().slice(0,10);
      const offset = getLocalOffsetISO(today);

      const url = `https://api.met.no/weatherapi/sunrise/3.0/sun?lat=${LAT}&lon=${LON}&date=${dateISO}&offset=${encodeURIComponent(offset)}`;
      try {
        const res = await fetch(`${WORKER_URL}?url=${encodeURIComponent(url)}`);
        if (!res.ok) throw new Error(`Sunrise HTTP ${res.status}`);
        const data = await res.json();

        const p = data?.properties ?? {};
        const sunriseISO = p?.sunrise?.time || null;
        const sunsetISO  = p?.sunset ?.time || null;

        const sunriseText = sunriseISO
          ? new Date(sunriseISO).toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false})
          : "â€”";
        const sunsetText  = sunsetISO
          ? new Date(sunsetISO ).toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false})
          : "â€”";

        document.getElementById("sunrise").textContent = sunriseText;
        document.getElementById("sunset").textContent  = sunsetText;

        if (!sunriseISO || !sunsetISO) {
          console.warn("[Sunrise] Manglende sunrise/sunset i svar:", data);
        }
      } catch (e) {
        console.error("[Sunrise] Feil ved henting/parsing:", e);
        document.getElementById("sunrise").textContent = "â€”";
        document.getElementById("sunset").textContent  = "â€”";
      }
    }
    fetchSun(); setInterval(fetchSun, 12 * 60 * 60 * 1000);

    
/********** ENTUR AVGANGER (via Worker, Quay per kolonne) **********/
  const ENTUR_GRAPHQL = "https://api.entur.io/journey-planner/v3/graphql";
  const departuresQuayQuery = `
    query($ids:[String!]!) {
      quays(ids:$ids) {
        id
        name
        stopPlace { name }
        estimatedCalls(timeRange: 14400, numberOfDepartures: 12) {
          realtime
          aimedDepartureTime
          expectedDepartureTime
          destinationDisplay { frontText }
          serviceJourney { journeyPattern { line { publicCode name } } }
        }
      }
    }`;

  function labelFromCalls(calls, fallbackName) {
    // Finn en representativ destinasjonstekst ("Nesttun terminal", "Ã˜yjorden", ...)
    // hvis mulig; ellers bruk fallback
    const first = (calls?.[0]?.destinationDisplay?.frontText || "").trim();
    if (!first) return fallbackName || "Kringlebotn";
    // lag et kortere "mot X" uten linjenr:
    return first ? `mot ${first}` : (fallbackName || "Kringlebotn");
  }

  function fillList(headerText, calls, nameId, listId) {
    document.getElementById(nameId).textContent = headerText;
    const ul = document.getElementById(listId);
    ul.innerHTML = "";
    if (!calls?.length) {
      const li = document.createElement("li");
      li.textContent = "Ingen avganger";
      ul.appendChild(li);
      return;
    }
    calls.slice(0, 8).forEach(call => {
      const when = new Date(call.expectedDepartureTime || call.aimedDepartureTime);
      const hhmm = isNaN(when) ? "â€”" : when.toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false});
      const line = call.serviceJourney?.journeyPattern?.line || {};
      const li = document.createElement("li");
      const left = document.createElement("span");
      left.textContent = `${line.publicCode ?? ""} ${call.destinationDisplay?.frontText ?? ""}`.trim();
      const right = document.createElement("span");
      right.innerHTML = `${hhmm}${call.realtime ? ' <span class="realtime">â€¢</span>' : ''}`;
      li.append(left, right);
      ul.appendChild(li);
    });
  }

  async function fetchDepartures() {
    try {
      const res = await fetch(
        `${WORKER_URL}?url=${encodeURIComponent(ENTUR_GRAPHQL)}`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "ET-Client-Name": ENTUR_CLIENT_NAME // Entur krever identifikasjon
          },
          body: JSON.stringify({
            query: departuresQuayQuery,
            variables: { ids: [STOP_A, STOP_B] } // Quay A og B
          })
        }
      );

      if (!res.ok) {
        const text = await res.text();
        console.error(`[Entur] HTTP ${res.status}`, text);
        return;
      }
      const json = await res.json();
      if (json.errors) {
        console.error("[Entur] GraphQL errors:", json.errors);
        return;
      }

      const quays = json?.data?.quays || [];
      if (quays.length === 0) {
        console.warn("[Entur] Tomt svar â€“ sjekk Quay-IDene.");
        return;
      }

      // Vi forventer 2 elementer (A og B). Fyll hver kolonne med sin Quay:
      const QA = quays[0], QB = quays[1];
      const headerA = labelFromCalls(QA?.estimatedCalls, QA?.stopPlace?.name || QA?.name);
      const headerB = labelFromCalls(QB?.estimatedCalls, QB?.stopPlace?.name || QB?.name);

      fillList(headerA, QA?.estimatedCalls, "stopA-name", "stopA-list");
      fillList(headerB, QB?.estimatedCalls, "stopB-name", "stopB-list");
    } catch (e) {
      console.error("[Entur] Unntak:", e);
    }
  }

  fetchDepartures();
  setInterval(fetchDepartures, 45 * 1000); // ikke polle raskere


    /********** KALENDER (ICS via Worker) **********/
    async function fetchCalendar() {
      if (!CALENDAR_ICS_URL.startsWith("http")) return; // ikke konfigurert ennÃ¥
      try {
        const txt = await (await fetch(`${WORKER_URL}?url=${encodeURIComponent(CALENDAR_ICS_URL)}`)).text();
        const jcal = ICAL.parse(txt);
        const comp = new ICAL.Component(jcal);
        const events = comp.getAllSubcomponents("vevent").map(v => new ICAL.Event(v));

        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const tomorrow = new Date(today.getTime() + 24*60*60*1000);

        function inRange(s,e,ds,de){ return (s < de) && (e > ds); }
        function render(dayStart, id) {
          const dayEnd = new Date(dayStart.getTime()+24*60*60*1000);
          const box = document.getElementById(id); box.innerHTML = "";
          const todays = [];
          for (const e of events) {
            const s = e.startDate.toJSDate();
            const eEnd = e.endDate ? e.endDate.toJSDate() : new Date(s.getTime()+60*60*1000);
            if (inRange(s, eEnd, dayStart, dayEnd)) {
              todays.push({summary:e.summary, start:s, end:eEnd, allDay:e.startDate.isDate});
            }
          }
          if (todays.length === 0) { box.textContent = "Ingen hendelser"; return; }
          todays.sort((a,b)=>a.start-b.start);
          for (const ev of todays) {
            const div = document.createElement("div");
            div.className = "event";
            const time = ev.allDay
              ? "Hele dagen"
              : `${ev.start.toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false})}â€“${ev.end.toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit",hour12:false})}`;
            div.innerHTML = `<strong>${ev.summary || "(uten tittel)"}</strong><br><span class="small">${time}</span>`;
            box.appendChild(div);
          }
        }
        render(today, "events-today");
        render(tomorrow, "events-tomorrow");
      } catch (e) {
        console.error("[Calendar]", e);
      }
    }
    fetchCalendar(); setInterval(fetchCalendar, 10 * 60 * 1000);
  </script>
</body>

</html>


